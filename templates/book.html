{% extends "layout.html" %}

{% block title %}预订 {{ tour.destination }} - 订车助手{% endblock %}

{% block content %}
<div style="max-width: 900px; margin: 0 auto;">
    <a href="/" class="btn" style="background: #6c757d; margin-bottom: 20px;"><i class="fas fa-arrow-left"></i> 返回首页</a>
    <div class="card">
        <h1><i class="fas fa-ticket-alt"></i> 预订 {{ tour.destination }}</h1>
        <p style="color: #666; margin: 15px 0;"><i class="far fa-calendar"></i> {{ tour.date }} {{ tour.time }} 出发 | <i class="fas fa-car"></i> 车辆: {{ tour.get('vehicle_model', '未指定') }}</p>
        
        <div class="book-page-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
            <div>
                <h3><i class="fas fa-edit"></i> 1. 选择座位</h3>
                <p style="color: #666; margin-bottom: 10px;">请点击下方选择座位：</p>
                <div class="seat-map" id="seatMap">
                    {% for seat_num in range(1, tour.max_seats + 1) %}
                        {% set seat_status = 'unavailable' if seat_num in taken_seats else 'available' %}
                        <div class="seat {{ seat_status }}" data-seat="{{ seat_num }}" onclick="selectSeat(this)">{{ seat_num }}号</div>
                    {% endfor %}
                </div>
                <p style="color: #666; margin-top: 10px;">已选座位：<span id="selectedSeatsDisplay">无</span></p>
                
                <h3 style="margin-top: 30px;"><i class="fas fa-user-edit"></i> 2. 填写信息</h3>
                <form id="bookingForm" onsubmit="submitBooking(event, {{ tour.id }})" style="margin-top: 20px;">
                    <input type="hidden" id="selectedSeatsInput" name="selectedSeats" value="">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">姓名 *</label>
                        <input type="text" id="customerName" required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">手机号 *</label>
                        <input type="tel" id="customerPhone" required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;" pattern="[0-9]{11}">
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 25px 0;">
                        <p><i class="fas fa-car"></i> 车辆型号: <strong>{{ tour.get('vehicle_model', '未指定') }}</strong></p>
                        <p><i class="fas fa-info-circle"></i> 本班次总座位: <strong>{{ tour.max_seats }}</strong> 个</p>
                        <p><i class="fas fa-chair"></i> 剩余空位: <strong style="color:#00b09b;">{{ tour.max_seats - tour.booked }}</strong> 个</p>
                        <p id="seatSelectionWarning" style="color:#e74c3c; display:none;"><i class="fas fa-exclamation-triangle"></i> 请至少选择一个座位！</p>
                    </div>
                    <button type="submit" class="btn" style="width: 100%; padding: 15px; font-size: 1.1rem;">
                        <i class="fas fa-check-circle"></i> 提交预订
                    </button>
                </form>
            </div>
            
            <div>
                <h3><i class="fas fa-list-check"></i> 班次详情</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #dee2e6;">
                        <span>目的地:</span><strong>{{ tour.destination }}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #dee2e6;">
                        <span>车辆型号:</span><strong>{{ tour.get('vehicle_model', '未指定') }}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #dee2e6;">
                        <span>出发时间:</span><strong>{{ tour.date }} {{ tour.time }}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #dee2e6;">
                        <span>总座位数:</span><strong>{{ tour.max_seats }} 座</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #dee2e6;">
                        <span>已预订:</span><strong>{{ tour.booked }} 人</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                        <span>状态:</span>
                        <span class="{% if tour.max_seats - tour.booked > 0 %}status-available{% else %}status-full{% endif %}">
                            {% if tour.max_seats - tour.booked > 0 %}正常预订中{% else %}已满员{% endif %}
                        </span>
                    </div>
                </div>
                
                <h3 style="margin-top: 30px;"><i class="fas fa-history"></i> 已预订座位</h3>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <p>已选座位: <strong>{{ taken_seats|join(', ') if taken_seats else "暂无" }}</strong></p>
                    <p>剩余空位: <strong style="color:#00b09b;">{{ tour.max_seats - taken_seats|length }}</strong> 个</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let selectedSeats = [];

function selectSeat(element) {
    if (element.classList.contains('unavailable')) return;
    
    const seatNum = parseInt(element.getAttribute('data-seat'));
    const index = selectedSeats.indexOf(seatNum);
    
    if (index === -1) {
        selectedSeats.push(seatNum);
        element.classList.add('selected');
    } else {
        selectedSeats.splice(index, 1);
        element.classList.remove('selected');
    }
    
    document.getElementById('selectedSeatsDisplay').textContent = 
        selectedSeats.length > 0 ? selectedSeats.join(', ') : '无';
    document.getElementById('selectedSeatsInput').value = selectedSeats.join(',');
    document.getElementById('seatSelectionWarning').style.display = 'none';
}

async function submitBooking(event, tourId) {
    event.preventDefault();
    
    if (selectedSeats.length === 0) {
        document.getElementById('seatSelectionWarning').style.display = 'block';
        return;
    }
    
    const name = document.getElementById('customerName').value;
    const phone = document.getElementById('customerPhone').value;
    const seats = selectedSeats;
    
    const btn = event.target.querySelector('button[type="submit"]');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 提交中...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/book', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                tour_id: tourId, 
                name: name, 
                phone: phone, 
                seat_numbers: seats
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('bookingForm').innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <i class="fas fa-check-circle" style="font-size: 4rem; color: #00b09b;"></i>
                    <h2>预订成功！</h2>
                    <p>您的座位已确认，请保存好预订码</p>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 25px 0; font-family: monospace;">
                        <p style="color: #666;">预订码</p>
                        <h1 style="color: #e74c3c; letter-spacing: 3px;">${result.booking_code}</h1>
                    </div>
                    <p><strong>已选座位：</strong>${seats.join(', ')}号</p>
                    <p><button class="btn" onclick="copyToClipboard('${result.booking_code}')" style="margin-top: 15px;">
                        <i class="fas fa-copy"></i> 复制预订码
                    </button></p>
                    <p style="margin-top: 20px;"><a href="/" class="btn" style="background: #6c757d;">返回首页</a></p>
                </div>
            `;
        } else {
            alert('预订失败: ' + result.message);
            btn.innerHTML = '<i class="fas fa-check-circle"></i> 提交预订';
            btn.disabled = false;
        }
    } catch (error) {
        alert('网络错误，请重试');
        btn.innerHTML = '<i class="fas fa-check-circle"></i> 提交预订';
        btn.disabled = false;
    }
}
</script>
{% endblock %}
