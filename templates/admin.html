{% extends "layout.html" %}

{% block title %}管理后台 - 订车助手{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1 style="color: white;"><i class="fas fa-cog"></i> 管理员界面</h1>
        <a href="/admin/logout" class="btn" style="background: #6c757d;"><i class="fas fa-sign-out-alt"></i> 退出登录</a>
    </div>
    <p style="color: rgba(255,255,255,0.8); margin-bottom: 30px;">所有数据总览与管理 | <a href="/" style="color: white;">返回首页</a></p>
    
    <!-- 统计卡片 -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="card" style="text-align: center;">
            <h3>总班次数</h3>
            <p style="font-size: 2rem; color: #6a11cb;">{{ tours_db|length }}</p>
        </div>
        <div class="card" style="text-align: center;">
            <h3>总预订数</h3>
            <p style="font-size: 2rem; color: #00b09b;">{{ bookings_db|length }}</p>
        </div>
        <div class="card" style="text-align: center;">
            <h3>已发车班次</h3>
            <p style="font-size: 2rem; color: #ff6b6b;">{{ tours_db|selectattr('date', 'time')|map('is_tour_departed')|list|sum }}</p>
        </div>
        <div class="card" style="text-align: center;">
            <h3>已满员班次</h3>
            <p style="font-size: 2rem; color: #e74c3c;">{{ tours_db|selectattr('booked', '>=', 'max_seats')|list|length }}</p>
        </div>
    </div>
    
    <div class="card">
        <h2><i class="fas fa-bus"></i> 班次管理</h2>
        <div style="overflow-x: auto; margin-top: 20px;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 12px; text-align: left;">ID</th>
                        <th style="padding: 12px; text-align: left;">目的地</th>
                        <th style="padding: 12px; text-align: left;">车辆型号</th>
                        <th style="padding: 12px; text-align: left;">出发时间</th>
                        <th style="padding: 12px; text-align: left;">总座位</th>
                        <th style="padding: 12px; text-align: left;">已预订</th>
                        <th style="padding: 12px; text-align: left;">状态</th>
                        <th style="padding: 12px; text-align: left;">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% if tours_db %}
                        {% for tour in tours_db %}
                            {% set departed = is_tour_departed(tour.date, tour.time) %}
                            {% set full = tour.booked >= tour.max_seats %}
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px;">{{ tour.id }}</td>
                                <td style="padding: 12px;"><strong>{{ tour.destination }}</strong></td>
                                <td style="padding: 12px;">{{ tour.get('vehicle_model', '未指定') }}</td>
                                <td style="padding: 12px;">{{ tour.date }} {{ tour.time }}</td>
                                <td style="padding: 12px;">{{ tour.max_seats }}</td>
                                <td style="padding: 12px;">{{ tour.booked }}</td>
                                <td style="padding: 12px;">
                                    {% if departed %}
                                        <span class="status-departed">已发车</span>
                                    {% elif full %}
                                        <span class="status-full">已满员</span>
                                    {% else %}
                                        <span class="status-available">进行中</span>
                                    {% endif %}
                                </td>
                                <td style="padding: 12px;">
                                    <a href="/book/{{ tour.id }}" class="btn" style="padding: 6px 12px; font-size: 0.8rem; margin-right: 5px;">查看</a>
                                    <button class="btn" style="padding: 6px 12px; font-size: 0.8rem; background: #e74c3c;" onclick="deleteTour({{ tour.id }})">删除</button>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="8" style="text-align:center;padding:20px;color:#666;">暂无班次</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="card">
        <h2><i class="fas fa-plus-circle"></i> 创建新班次</h2>
        <form onsubmit="createTour(event)" style="margin-top: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">出发日期</label>
                    <input type="date" id="newTourDate" required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">出发时间</label>
                    <input type="time" id="newTourTime" required value="08:00" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">目的地</label>
                    <input type="text" id="newTourDest" required placeholder="例如：北京故宫" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">车辆型号</label>
                    <input type="text" id="newTourVehicle" required placeholder="例如：奥迪A6" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                </div>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">总座位数</label>
                <input type="number" id="newTourSeats" required min="1" max="50" value="6" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                <small style="color: #666;">可设置1-50之间的数字，例如：大巴车可设40座，商务车可设6座</small>
            </div>
            <button type="submit" class="btn" style="width: 100%;">
                <i class="fas fa-plus"></i> 创建新班次
            </button>
        </form>
    </div>
    
    <div class="card">
        <h2><i class="fas fa-list-alt"></i> 所有预订详情</h2>
        <p style="color: #666; margin-bottom: 15px;">这里显示所有客户的完整预订信息</p>
        <div style="overflow-x: auto; margin-top: 20px;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 10px; text-align: left;">预订码</th>
                        <th style="padding: 10px; text-align: left;">姓名</th>
                        <th style="padding: 10px; text-align: left;">手机</th>
                        <th style="padding: 10px; text-align: left;">班次</th>
                        <th style="padding: 10px; text-align: left;">车辆型号</th>
                        <th style="padding: 10px; text-align: left;">座位号</th>
                        <th style="padding: 10px; text-align: left;">预订时间</th>
                    </tr>
                </thead>
                <tbody>
                    {% if bookings_db %}
                        {% for booking in bookings_db %}
                            {% set tour_info = tours_db|selectattr('id', 'equalto', booking.tour_id)|first|default({}) %}
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 10px;">{{ booking.code }}</td>
                                <td style="padding: 10px;">{{ booking.name }}</td>
                                <td style="padding: 10px;">{{ booking.phone }}</td>
                                <td style="padding: 10px;">{{ tour_info.get('destination', '未知') }}</td>
                                <td style="padding: 10px;">{{ tour_info.get('vehicle_model', '未指定') }}</td>
                                <td style="padding: 10px;">
                                    {% if booking.seat_numbers is string %}
                                        {{ booking.seat_numbers }}
                                    {% elif booking.seat_numbers is sequence %}
                                        {{ booking.seat_numbers|join(', ') }}
                                    {% else %}
                                        无
                                    {% endif %}
                                </td>
                                <td style="padding: 10px;">{{ booking.created_at }}</td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="7" style="text-align:center;padding:20px;color:#666;">暂无预订记录</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const dateInput = document.getElementById('newTourDate');
    if (dateInput) {
        dateInput.value = tomorrow.toISOString().split('T')[0];
    }
});

async function createTour(event) {
    event.preventDefault();
    const date = document.getElementById('newTourDate').value;
    const time = document.getElementById('newTourTime').value;
    const dest = document.getElementById('newTourDest').value;
    const vehicle = document.getElementById('newTourVehicle').value;
    const seats = parseInt(document.getElementById('newTourSeats').value);
    
    const response = await fetch('/api/create_tour', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            date: date, 
            time: time, 
            destination: dest, 
            vehicle_model: vehicle, 
            max_seats: seats 
        })
    });
    
    const result = await response.json();
    if (result.success) {
        alert('创建成功！页面将刷新...');
        location.reload();
    } else {
        alert('创建失败: ' + result.message);
    }
}

async function deleteTour(tourId) {
    if (!confirm('确定要删除这个班次吗？相关的所有预订也将被删除！')) return;
    
    const response = await fetch('/api/delete_tour', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tour_id: tourId })
    });
    
    const result = await response.json();
    if (result.success) {
        alert('删除成功！页面将刷新...');
        location.reload();
    } else {
        alert('删除失败: ' + result.message);
    }
}
</script>
{% endblock %}
